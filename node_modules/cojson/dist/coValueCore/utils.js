import { getGroupDependentKey } from "../ids.js";
import { parseJSON } from "../jsonStringify.js";
import { accountOrAgentIDfromSessionID } from "../typeUtils/accountOrAgentIDfromSessionID.js";
import { isAccountID } from "../typeUtils/isAccountID.js";
export function getDependedOnCoValuesFromRawData(id, header, sessions, transactions) {
    const deps = new Set();
    for (const session of sessions) {
        const accountId = accountOrAgentIDfromSessionID(session);
        if (isAccountID(accountId) && accountId !== id) {
            deps.add(accountId);
        }
    }
    if (header.ruleset.type === "group") {
        for (const txs of transactions) {
            for (const tx of txs) {
                if (tx.privacy !== "trusting")
                    continue;
                const changes = safeParseChanges(tx.changes);
                for (const change of changes) {
                    if (change &&
                        typeof change === "object" &&
                        "op" in change &&
                        change.op === "set" &&
                        "key" in change &&
                        change.key) {
                        const key = getGroupDependentKey(change.key);
                        if (key && key !== id) {
                            deps.add(key);
                        }
                    }
                }
            }
        }
    }
    if (header.ruleset.type === "ownedByGroup") {
        deps.add(header.ruleset.group);
    }
    return deps;
}
function safeParseChanges(value) {
    try {
        return parseJSON(value);
    }
    catch (e) {
        return [];
    }
}
//# sourceMappingURL=utils.js.map